<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>黑客反汇编揭秘笔记-3 | 吾行吾道，虽远必至</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="icon" href="/icons/favicon.ico">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
    <meta name="description" content="分享zjgcjy的个人笔记、读书论文、学习知识">
    <meta name="author" content="zjgcjy">
    <meta name="keywords" content="blog, document, zjgcjy">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/android-chrome-192x192.png">
    <meta name="msapplication-TileColor" content="#000000">
    <link rel="preload" href="/assets/css/0.styles.cc7da0d3.css" as="style"><link rel="preload" href="/assets/js/app.68a3742c.js" as="script"><link rel="preload" href="/assets/js/8.fcc732cc.js" as="script"><link rel="preload" href="/assets/js/3.c25269db.js" as="script"><link rel="preload" href="/assets/js/38.9cad802b.js" as="script"><link rel="preload" href="/assets/js/4.4107640d.js" as="script"><link rel="prefetch" href="/assets/js/10.0271d235.js"><link rel="prefetch" href="/assets/js/100.73ccab85.js"><link rel="prefetch" href="/assets/js/101.497c637e.js"><link rel="prefetch" href="/assets/js/102.6a6065e0.js"><link rel="prefetch" href="/assets/js/103.da1e4979.js"><link rel="prefetch" href="/assets/js/104.9363fa0e.js"><link rel="prefetch" href="/assets/js/105.56aeaccd.js"><link rel="prefetch" href="/assets/js/106.2d9c4287.js"><link rel="prefetch" href="/assets/js/107.5e7526a0.js"><link rel="prefetch" href="/assets/js/108.e7fa9af1.js"><link rel="prefetch" href="/assets/js/109.17ee481c.js"><link rel="prefetch" href="/assets/js/11.b927763a.js"><link rel="prefetch" href="/assets/js/110.04d48135.js"><link rel="prefetch" href="/assets/js/111.0d926bcc.js"><link rel="prefetch" href="/assets/js/112.98700d64.js"><link rel="prefetch" href="/assets/js/113.4d7c030c.js"><link rel="prefetch" href="/assets/js/114.d1fa09ba.js"><link rel="prefetch" href="/assets/js/115.2d6dc7c6.js"><link rel="prefetch" href="/assets/js/116.7fb71c1d.js"><link rel="prefetch" href="/assets/js/117.be77b46b.js"><link rel="prefetch" href="/assets/js/118.02880a8d.js"><link rel="prefetch" href="/assets/js/119.b5e6a59b.js"><link rel="prefetch" href="/assets/js/12.6639be01.js"><link rel="prefetch" href="/assets/js/120.e1d83985.js"><link rel="prefetch" href="/assets/js/121.d5689be0.js"><link rel="prefetch" href="/assets/js/122.7965ddb1.js"><link rel="prefetch" href="/assets/js/123.075bc23a.js"><link rel="prefetch" href="/assets/js/124.171067a0.js"><link rel="prefetch" href="/assets/js/125.3bd1b343.js"><link rel="prefetch" href="/assets/js/126.2decc719.js"><link rel="prefetch" href="/assets/js/127.5918153e.js"><link rel="prefetch" href="/assets/js/128.2369a9c6.js"><link rel="prefetch" href="/assets/js/129.a6e9329f.js"><link rel="prefetch" href="/assets/js/13.1dd0223d.js"><link rel="prefetch" href="/assets/js/130.8f33531d.js"><link rel="prefetch" href="/assets/js/131.ebca5e1e.js"><link rel="prefetch" href="/assets/js/132.f7710604.js"><link rel="prefetch" href="/assets/js/133.0a3aa14b.js"><link rel="prefetch" href="/assets/js/134.82f68851.js"><link rel="prefetch" href="/assets/js/135.f1f02674.js"><link rel="prefetch" href="/assets/js/136.9067c6db.js"><link rel="prefetch" href="/assets/js/137.26eb8263.js"><link rel="prefetch" href="/assets/js/138.fd1f4c11.js"><link rel="prefetch" href="/assets/js/139.2aae2ad3.js"><link rel="prefetch" href="/assets/js/14.23ba167e.js"><link rel="prefetch" href="/assets/js/140.9e378629.js"><link rel="prefetch" href="/assets/js/141.48037576.js"><link rel="prefetch" href="/assets/js/142.ec8652d4.js"><link rel="prefetch" href="/assets/js/143.c680281a.js"><link rel="prefetch" href="/assets/js/144.1bc6559d.js"><link rel="prefetch" href="/assets/js/145.cbad0cbe.js"><link rel="prefetch" href="/assets/js/146.3a9cb649.js"><link rel="prefetch" href="/assets/js/147.b9f039d6.js"><link rel="prefetch" href="/assets/js/148.97fa3f98.js"><link rel="prefetch" href="/assets/js/149.2ebcef8c.js"><link rel="prefetch" href="/assets/js/15.e6b8adea.js"><link rel="prefetch" href="/assets/js/150.52f3ef19.js"><link rel="prefetch" href="/assets/js/151.7c0a3d38.js"><link rel="prefetch" href="/assets/js/152.ca45bb96.js"><link rel="prefetch" href="/assets/js/153.52ac6d38.js"><link rel="prefetch" href="/assets/js/154.deb9a6f7.js"><link rel="prefetch" href="/assets/js/155.70e19b71.js"><link rel="prefetch" href="/assets/js/156.e40a7790.js"><link rel="prefetch" href="/assets/js/157.ad178633.js"><link rel="prefetch" href="/assets/js/158.6c1a10e5.js"><link rel="prefetch" href="/assets/js/159.20aa9991.js"><link rel="prefetch" href="/assets/js/16.08eb7089.js"><link rel="prefetch" href="/assets/js/160.c66825a5.js"><link rel="prefetch" href="/assets/js/161.fb1763c2.js"><link rel="prefetch" href="/assets/js/162.a9cf6445.js"><link rel="prefetch" href="/assets/js/163.929dc1a1.js"><link rel="prefetch" href="/assets/js/164.3446b5ea.js"><link rel="prefetch" href="/assets/js/165.e98813c0.js"><link rel="prefetch" href="/assets/js/166.e9bec170.js"><link rel="prefetch" href="/assets/js/167.2051a22a.js"><link rel="prefetch" href="/assets/js/168.5be3f436.js"><link rel="prefetch" href="/assets/js/169.e5527396.js"><link rel="prefetch" href="/assets/js/17.597e5dd3.js"><link rel="prefetch" href="/assets/js/170.65d819bd.js"><link rel="prefetch" href="/assets/js/171.595d02ff.js"><link rel="prefetch" href="/assets/js/172.466410bc.js"><link rel="prefetch" href="/assets/js/173.2b9ce80d.js"><link rel="prefetch" href="/assets/js/174.5a9b378d.js"><link rel="prefetch" href="/assets/js/175.ff6f195c.js"><link rel="prefetch" href="/assets/js/176.5d341055.js"><link rel="prefetch" href="/assets/js/177.276792bd.js"><link rel="prefetch" href="/assets/js/178.d9fa3f3c.js"><link rel="prefetch" href="/assets/js/179.4c4117cc.js"><link rel="prefetch" href="/assets/js/18.725eeea4.js"><link rel="prefetch" href="/assets/js/180.4fff44cd.js"><link rel="prefetch" href="/assets/js/181.d307f527.js"><link rel="prefetch" href="/assets/js/182.ddc4c69e.js"><link rel="prefetch" href="/assets/js/183.b06bad5b.js"><link rel="prefetch" href="/assets/js/184.50aa9621.js"><link rel="prefetch" href="/assets/js/185.8d7fb525.js"><link rel="prefetch" href="/assets/js/186.2be8e7eb.js"><link rel="prefetch" href="/assets/js/19.a671dd4c.js"><link rel="prefetch" href="/assets/js/20.8b5a0dec.js"><link rel="prefetch" href="/assets/js/21.69c7a200.js"><link rel="prefetch" href="/assets/js/22.0a580e46.js"><link rel="prefetch" href="/assets/js/23.83386dac.js"><link rel="prefetch" href="/assets/js/24.338cbb58.js"><link rel="prefetch" href="/assets/js/25.d2abd85f.js"><link rel="prefetch" href="/assets/js/26.3b38c049.js"><link rel="prefetch" href="/assets/js/27.d9dae9aa.js"><link rel="prefetch" href="/assets/js/28.71693298.js"><link rel="prefetch" href="/assets/js/29.ee405def.js"><link rel="prefetch" href="/assets/js/30.26ea0909.js"><link rel="prefetch" href="/assets/js/31.39850fdd.js"><link rel="prefetch" href="/assets/js/32.53c724d8.js"><link rel="prefetch" href="/assets/js/33.752a7109.js"><link rel="prefetch" href="/assets/js/34.c63048fa.js"><link rel="prefetch" href="/assets/js/35.759b96e1.js"><link rel="prefetch" href="/assets/js/36.66df340f.js"><link rel="prefetch" href="/assets/js/37.e5db91a1.js"><link rel="prefetch" href="/assets/js/39.32c4b1b9.js"><link rel="prefetch" href="/assets/js/40.5d6c3ee5.js"><link rel="prefetch" href="/assets/js/41.9a6cb5ed.js"><link rel="prefetch" href="/assets/js/42.0a64a88f.js"><link rel="prefetch" href="/assets/js/43.2ba6bf5c.js"><link rel="prefetch" href="/assets/js/44.db12948c.js"><link rel="prefetch" href="/assets/js/45.53751c2b.js"><link rel="prefetch" href="/assets/js/46.24e53f98.js"><link rel="prefetch" href="/assets/js/47.345437a0.js"><link rel="prefetch" href="/assets/js/48.4bfa695d.js"><link rel="prefetch" href="/assets/js/49.9ed589b3.js"><link rel="prefetch" href="/assets/js/5.e06a07f3.js"><link rel="prefetch" href="/assets/js/50.ee8ab96d.js"><link rel="prefetch" href="/assets/js/51.8487460e.js"><link rel="prefetch" href="/assets/js/52.c498828c.js"><link rel="prefetch" href="/assets/js/53.853f78c2.js"><link rel="prefetch" href="/assets/js/54.0dca34e1.js"><link rel="prefetch" href="/assets/js/55.663ed030.js"><link rel="prefetch" href="/assets/js/56.be199d77.js"><link rel="prefetch" href="/assets/js/57.81f06755.js"><link rel="prefetch" href="/assets/js/58.e6fa55a3.js"><link rel="prefetch" href="/assets/js/59.d53d2a62.js"><link rel="prefetch" href="/assets/js/6.12cd8bce.js"><link rel="prefetch" href="/assets/js/60.370f4042.js"><link rel="prefetch" href="/assets/js/61.8a6f154e.js"><link rel="prefetch" href="/assets/js/62.5bae4ce6.js"><link rel="prefetch" href="/assets/js/63.283216aa.js"><link rel="prefetch" href="/assets/js/64.cc2a57fc.js"><link rel="prefetch" href="/assets/js/65.2f196fe0.js"><link rel="prefetch" href="/assets/js/66.9dbcea4e.js"><link rel="prefetch" href="/assets/js/67.624a7ecb.js"><link rel="prefetch" href="/assets/js/68.8aca7db7.js"><link rel="prefetch" href="/assets/js/69.a8907f50.js"><link rel="prefetch" href="/assets/js/7.904ddc2a.js"><link rel="prefetch" href="/assets/js/70.639bbbcd.js"><link rel="prefetch" href="/assets/js/71.f2b0c50a.js"><link rel="prefetch" href="/assets/js/72.f29db23d.js"><link rel="prefetch" href="/assets/js/73.361a6f13.js"><link rel="prefetch" href="/assets/js/74.07940d04.js"><link rel="prefetch" href="/assets/js/75.8b29e170.js"><link rel="prefetch" href="/assets/js/76.619541d5.js"><link rel="prefetch" href="/assets/js/77.a80ea87d.js"><link rel="prefetch" href="/assets/js/78.437cb18c.js"><link rel="prefetch" href="/assets/js/79.2a15f1bc.js"><link rel="prefetch" href="/assets/js/80.a22b58d8.js"><link rel="prefetch" href="/assets/js/81.53873a7a.js"><link rel="prefetch" href="/assets/js/82.a26adcd3.js"><link rel="prefetch" href="/assets/js/83.30fbbf9b.js"><link rel="prefetch" href="/assets/js/84.944f1cc7.js"><link rel="prefetch" href="/assets/js/85.3dd16320.js"><link rel="prefetch" href="/assets/js/86.3963f0ca.js"><link rel="prefetch" href="/assets/js/87.fc3fdad9.js"><link rel="prefetch" href="/assets/js/88.baa2ea83.js"><link rel="prefetch" href="/assets/js/89.f52c75f2.js"><link rel="prefetch" href="/assets/js/9.bdd93fc9.js"><link rel="prefetch" href="/assets/js/90.53cefb41.js"><link rel="prefetch" href="/assets/js/91.7e245ed3.js"><link rel="prefetch" href="/assets/js/92.dd2dc4bf.js"><link rel="prefetch" href="/assets/js/93.1ca01b70.js"><link rel="prefetch" href="/assets/js/94.9cff327e.js"><link rel="prefetch" href="/assets/js/95.6774e292.js"><link rel="prefetch" href="/assets/js/96.95587ad8.js"><link rel="prefetch" href="/assets/js/97.92c8d5d5.js"><link rel="prefetch" href="/assets/js/98.4b2392de.js"><link rel="prefetch" href="/assets/js/99.8d4ffc5c.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.7c4717f8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.cc7da0d3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/nav-logo.png" alt="吾行吾道，虽远必至" class="logo"> <span class="site-name can-hide">吾行吾道，虽远必至</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档" class="dropdown-title"><span class="title">文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          论文
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/papers/academic_papers/" class="nav-link">
  学术论文
</a></li></ul></li><li class="dropdown-item"><h4>
          其他
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/papers/other_papers/" class="nav-link">
  其他文章
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CTF" class="dropdown-title"><span class="title">CTF</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          CTF笔记
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/ctf/reverse/" class="nav-link router-link-active">
  Reverse
</a></li><li class="dropdown-subitem"><a href="/ctf/pwn/" class="nav-link">
  Pwn
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/ctf/writeup/" class="nav-link">
  writeup
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="语言" class="dropdown-title"><span class="title">语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/languages/cplusplus/" class="nav-link">
  C++
</a></li><li class="dropdown-item"><!----> <a href="/languages/python/" class="nav-link">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/languages/android/" class="nav-link">
  Android
</a></li><li class="dropdown-item"><!----> <a href="/languages/golang/" class="nav-link">
  Golang
</a></li><li class="dropdown-item"><!----> <a href="/languages/rust/" class="nav-link">
  Rust
</a></li><li class="dropdown-item"><!----> <a href="/languages/vc/" class="nav-link">
  VC
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具与项目" class="dropdown-title"><span class="title">工具与项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tools/" class="nav-link">
  工具
</a></li><li class="dropdown-item"><!----> <a href="/projects/" class="nav-link">
  项目
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="杂谈" class="dropdown-title"><span class="title">杂谈</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/diary/" class="nav-link">
  日记
</a></li><li class="dropdown-item"><!----> <a href="/others/" class="nav-link">
  其他
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多vuepress" class="dropdown-title"><span class="title">vuepress</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          指南
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue/guide/" class="nav-link">
  指南
</a></li><li class="dropdown-subitem"><a href="/vue/config/" class="nav-link">
  配置
</a></li></ul></li><li class="dropdown-item"><h4>
          主题与插件
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue/plugin/" class="nav-link">
  插件
</a></li><li class="dropdown-subitem"><a href="/vue/theme/" class="nav-link">
  主题
</a></li></ul></li><li class="dropdown-item"><h4>
          API
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue/api/cli.html" class="nav-link">
  CLI
</a></li><li class="dropdown-subitem"><a href="/vue/api/node.html" class="nav-link">
  Node
</a></li></ul></li><li class="dropdown-item"><h4>
          开发指南
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue/miscellaneous/local-development.html" class="nav-link">
  本地开发
</a></li><li class="dropdown-subitem"><a href="/vue/miscellaneous/design-concepts.html" class="nav-link">
  设计理念
</a></li><li class="dropdown-subitem"><a href="/vue/faq/" class="nav-link">
  FAQ
</a></li><li class="dropdown-subitem"><a href="/vue/miscellaneous/glossary.html" class="nav-link">
  术语
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="关于" class="dropdown-title"><span class="title">关于</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/about.html" class="nav-link">
  关于我
</a></li><li class="dropdown-item"><!----> <a href="https://github.com/zjgcjy" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档" class="dropdown-title"><span class="title">文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          论文
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/papers/academic_papers/" class="nav-link">
  学术论文
</a></li></ul></li><li class="dropdown-item"><h4>
          其他
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/papers/other_papers/" class="nav-link">
  其他文章
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CTF" class="dropdown-title"><span class="title">CTF</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          CTF笔记
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/ctf/reverse/" class="nav-link router-link-active">
  Reverse
</a></li><li class="dropdown-subitem"><a href="/ctf/pwn/" class="nav-link">
  Pwn
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/ctf/writeup/" class="nav-link">
  writeup
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="语言" class="dropdown-title"><span class="title">语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/languages/cplusplus/" class="nav-link">
  C++
</a></li><li class="dropdown-item"><!----> <a href="/languages/python/" class="nav-link">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/languages/android/" class="nav-link">
  Android
</a></li><li class="dropdown-item"><!----> <a href="/languages/golang/" class="nav-link">
  Golang
</a></li><li class="dropdown-item"><!----> <a href="/languages/rust/" class="nav-link">
  Rust
</a></li><li class="dropdown-item"><!----> <a href="/languages/vc/" class="nav-link">
  VC
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具与项目" class="dropdown-title"><span class="title">工具与项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tools/" class="nav-link">
  工具
</a></li><li class="dropdown-item"><!----> <a href="/projects/" class="nav-link">
  项目
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="杂谈" class="dropdown-title"><span class="title">杂谈</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/diary/" class="nav-link">
  日记
</a></li><li class="dropdown-item"><!----> <a href="/others/" class="nav-link">
  其他
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多vuepress" class="dropdown-title"><span class="title">vuepress</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          指南
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue/guide/" class="nav-link">
  指南
</a></li><li class="dropdown-subitem"><a href="/vue/config/" class="nav-link">
  配置
</a></li></ul></li><li class="dropdown-item"><h4>
          主题与插件
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue/plugin/" class="nav-link">
  插件
</a></li><li class="dropdown-subitem"><a href="/vue/theme/" class="nav-link">
  主题
</a></li></ul></li><li class="dropdown-item"><h4>
          API
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue/api/cli.html" class="nav-link">
  CLI
</a></li><li class="dropdown-subitem"><a href="/vue/api/node.html" class="nav-link">
  Node
</a></li></ul></li><li class="dropdown-item"><h4>
          开发指南
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue/miscellaneous/local-development.html" class="nav-link">
  本地开发
</a></li><li class="dropdown-subitem"><a href="/vue/miscellaneous/design-concepts.html" class="nav-link">
  设计理念
</a></li><li class="dropdown-subitem"><a href="/vue/faq/" class="nav-link">
  FAQ
</a></li><li class="dropdown-subitem"><a href="/vue/miscellaneous/glossary.html" class="nav-link">
  术语
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="关于" class="dropdown-title"><span class="title">关于</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/about.html" class="nav-link">
  关于我
</a></li><li class="dropdown-item"><!----> <a href="https://github.com/zjgcjy" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/ctf/reverse/" class="sidebar-link">reverse简介</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>《IDApro代码破解揭秘》笔记</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>《黑客反汇编揭秘》笔记</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/ctf/reverse/learning-hacker-disassembling-1.html" class="sidebar-link">黑客反汇编揭秘笔记-1</a></li><li><a href="/ctf/reverse/learning-hacker-disassembling-2.html" class="sidebar-link">黑客反汇编揭秘笔记-2</a></li><li><a href="/ctf/reverse/learning-hacker-disassembling-3.html" class="active sidebar-link">黑客反汇编揭秘笔记-3</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ctf/reverse/learning-hacker-disassembling-3.html#第13章" class="sidebar-link">第13章</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ctf/reverse/learning-hacker-disassembling-3.html#关于x86-64体系结构" class="sidebar-link">关于X86-64体系结构</a></li></ul></li><li class="sidebar-sub-header"><a href="/ctf/reverse/learning-hacker-disassembling-3.html#第17章" class="sidebar-link">第17章</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ctf/reverse/learning-hacker-disassembling-3.html#teb" class="sidebar-link">TEB</a></li><li class="sidebar-sub-header"><a href="/ctf/reverse/learning-hacker-disassembling-3.html#peb" class="sidebar-link">PEB</a></li><li class="sidebar-sub-header"><a href="/ctf/reverse/learning-hacker-disassembling-3.html#x64下注意点" class="sidebar-link">x64下注意点</a></li><li class="sidebar-sub-header"><a href="/ctf/reverse/learning-hacker-disassembling-3.html#seh" class="sidebar-link">SEH</a></li><li class="sidebar-sub-header"><a href="/ctf/reverse/learning-hacker-disassembling-3.html#veh、seh、vch、uef的系统实现" class="sidebar-link">VEH、SEH、VCH、UEF的系统实现</a></li><li class="sidebar-sub-header"><a href="/ctf/reverse/learning-hacker-disassembling-3.html#异常处理机制执行顺序" class="sidebar-link">异常处理机制执行顺序</a></li></ul></li></ul></li><li><a href="/ctf/reverse/learning-hacker-disassembling-4.html" class="sidebar-link">黑客反汇编揭秘笔记-4</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>逆向方法与工具使用</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他笔记（施工中）</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><hr> <blockquote><p>本篇是《Hacker Disassembling Uncovered》的笔记。由于这本书出的时间比较长了，我看的版本还是08年出的，里面有很多东西没什么学习的必要，不过多读点书还是好的吧。在这里记个备忘。</p></blockquote> <h2 id="第13章"><a href="#第13章" class="header-anchor">#</a> 第13章</h2> <h3 id="关于x86-64体系结构"><a href="#关于x86-64体系结构" class="header-anchor">#</a> 关于X86-64体系结构</h3> <p>寄存器方面，额外提供了8个基础寄存器，除了原来的8个寄存器外，现在就有16个GPR了。新的寄存器的编号是从R8到R15，要访问他们的低8位，低16位和低32位可以分别使用b、w和d后缀。应用编程寄存器还包括128位的媒体控制寄存器。
关于寻址，在x64中不存在绝对寻址。
关于传参。使用fastcall调用约定，即第一个参数（最左边）用ecx，第二个用edx，第三个用r8，第四个用r9。若参数数量大于5，则使用压栈的方式。这里说的应该是windows的，linux64中的传参方式用了6个寄存器，从左到右依次是edi，esi，edx，ecx，r8，r9。</p> <h2 id="第17章"><a href="#第17章" class="header-anchor">#</a> 第17章</h2> <p>首先复习一下TEB、PEB和fs寄存器。</p> <h3 id="teb"><a href="#teb" class="header-anchor">#</a> TEB</h3> <p>线程环境块，位于用户地址空间，在比 PEB 所在地址低的地方。包含进程中运行线程的各种信息，每个线程都对应一个TEB结构体。一个进程的所有TEB都以堆栈的方式，存放在线性内存中。在用户态可通过CPU的FS寄存器来访问该段，因为FS寄存器在用户态的时候总是指向当前线程的TEB，一般存储在[FS:0]。还可以通过OS提供的API <code>Ntdll.NtCurrentTeb()</code>来访问TEB的地址。该函数原理如下：</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>mov eax, DWORD PTR FS:<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span>
RETN
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>关于TEB中的每一项的内容，我这里只介绍常用的部分。</p> <h4 id="_0x000-nttib"><a href="#_0x000-nttib" class="header-anchor">#</a> +0x000 NtTib</h4> <p>TEB的结构体的第一个成员NtTib即为我们常说的TIB线程信息块。其中0x00位置指向 <code>\_EXCEPTION_REGISTRATION_RECORD</code> 结构体的链表指针（SEH）。0x18位置为_NT_TIB结构体的self指针，即为NtCurrentTeb() 函数所读出的TEB结构体指针。</p> <h4 id="_0x020-clientid"><a href="#_0x020-clientid" class="header-anchor">#</a> +0x020 ClientId</h4> <p>有2个变量，其中位于0x020的是UniqueProcess，为当前进程的的Pid，可用函数 GetCurrentProcessId() 访问当前结构体成员获取进程标识符。另一个变量位于0x024的是UniqueThread，为当前进程的的Tid，可用函数 GetCurrentThreadId() 访问当前结构体成员获取线程标识符。原理如下：</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token punctuation">;</span>获取pid
mov eax, dword ptr fs:<span class="token punctuation">[</span>0x18<span class="token punctuation">]</span>
mov eax, dword ptr <span class="token punctuation">[</span>eax+0x20<span class="token punctuation">]</span>
<span class="token punctuation">;</span>获取tid
mov eax, dword ptr fs:<span class="token punctuation">[</span>0x18<span class="token punctuation">]</span>
mov eax, dword ptr <span class="token punctuation">[</span>eax+0x24<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="_0x030-processenvironmentblock"><a href="#_0x030-processenvironmentblock" class="header-anchor">#</a> +0x030 ProcessEnvironmentBlock</h4> <p>这里存放的是PEB结构体的指针，所以说一般 fs:[0x30] 即为PEB的起始地址。</p> <h3 id="peb"><a href="#peb" class="header-anchor">#</a> PEB</h3> <p>进程环境块，位于用户地址空间。存放进程信息，每个进程都有自己的PEB信息。PEB地址应从系统的EPROCESS结构的0x1b0偏移处获得，但访问EPROCESS需要ring0的权限。用户态可以通过TEB结构的偏移0x30处获得PEB的位置。<code>mov eax,fs:[0x30]</code></p> <h4 id="_0x002-beingdebugged"><a href="#_0x002-beingdebugged" class="header-anchor">#</a> +0x002 BeingDebugged</h4> <p>表示当前进程是否处于调试状态，也就是函数 IsDebuggerPresent() 所访问的结构体成员。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>mov eax, byte ptr fs:<span class="token punctuation">[</span>0x30<span class="token punctuation">]</span>
movzx eax, byte ptr <span class="token punctuation">[</span>eax+0x2<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="_0x018-processheap"><a href="#_0x018-processheap" class="header-anchor">#</a> +0x018 ProcessHeap</h4> <p>这个结构体成员就是进程堆的句柄，也就是指向结构体HEAP的指针。该结构体成员指向的HEAP结构体指针可用函数 GetProcessHeap()获取。其中偏移量是0x00c是Flags，0x010是ForceFlags。程序正常运行时，两个值分别是2和0。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>mov eax, byte ptr fs:<span class="token punctuation">[</span>0x30<span class="token punctuation">]</span>
movzx eax, byte ptr <span class="token punctuation">[</span>eax+0x18<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="_0x068-ntglobalflag"><a href="#_0x068-ntglobalflag" class="header-anchor">#</a> +0x068 NtGlobalFlag</h4> <p>在调试状态时，NtGlobalFlag 的值为0x70。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>mov eax, byte ptr fs:<span class="token punctuation">[</span>0x30<span class="token punctuation">]</span>
movzx eax, byte ptr <span class="token punctuation">[</span>eax+0x68<span class="token punctuation">]</span>
<span class="token builtin class-name">test</span> eax, 0x70
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>关于PEB和TEB之间的关系，总结如下。
FS:[0x18] = FS:[0x00] （0x18处就是self指针）
FS:[0x30] = &amp;PEB
FS:[0x00] = &amp;SEH</p> <h3 id="x64下注意点"><a href="#x64下注意点" class="header-anchor">#</a> x64下注意点</h3> <p>上面讨论的包括fs寄存器在内都是在x86基础内的，在x86中，fs段寄存器用于指向TEB和处理器控制区（Processor Control Region, KPCR）。但是，到了x64的时，fs的角色已经换成了gs。gs段寄存器在用户态指向TEB，在内核态指向KPCR。然而，当运行WOW64程序中，fs存器仍然指向32位的TEB。而且偏移量也不一样了。gs+0x30是TEB的self指针。其他wiki上也没有。。</p> <h3 id="seh"><a href="#seh" class="header-anchor">#</a> SEH</h3> <p>结构化异常处理SEH是Windows操作系统提供的强大异常处理功能。而Visual C++中的__try{}/__finally{}和__try{}/__except{}结构本质上是对Windows提供的SEH的封装。<strong>注意：SEH是基于线程的异常处理</strong>。而且except和finally不像java或者python一样可以公用，在C里面是不可以一起用的。而且在try块中使用__leave关键字会使程序跳转到try块的结尾，从而自然的进入finally块。</p> <h4 id="封装在vc中的seh"><a href="#封装在vc中的seh" class="header-anchor">#</a> 封装在VC中的SEH</h4> <p>常见的流程如下。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>__try <span class="token punctuation">{</span>
       <span class="token comment">// 受保护的代码</span>
<span class="token punctuation">}</span>
<span class="token function">__except</span> <span class="token punctuation">(</span> <span class="token comment">/*异常过滤器exception filter*/</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// 异常处理程序exception handler</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><img src="/img/2018-04/Snipaste_2018-03-29_20-44-09.png" alt="SEH流程"></p> <p>其中异常过滤器只有三个可能的值（定义在Windows的Excpt.h中）
<code>EXCEPTION_EXECUTE_HANDLER</code>      1     表示该异常被处理。从异常处下一条指令继续执行
<code>EXCEPTION_CONTINUE_SERCH</code>       0     表示不能处理该异常，继续搜索执行下一个EH
<code>EXCEPTION_CONTINUE_EXECUTION</code>  -1     表示该异常被忽略。从异常处处继续执行
两种基本的使用方式：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//方式一：直接使用过滤器的三个返回值之一</span>
__try <span class="token punctuation">{</span>
   ……
<span class="token punctuation">}</span>
<span class="token function">__except</span> <span class="token punctuation">(</span> EXCEPTION_EXECUTE_HANDLER <span class="token punctuation">)</span> <span class="token punctuation">{</span>
   ……
<span class="token punctuation">}</span>

<span class="token comment">//方式二：自定义过滤器</span>
__try <span class="token punctuation">{</span>
   ……
<span class="token punctuation">}</span>
<span class="token function">__except</span> <span class="token punctuation">(</span> <span class="token function">MyFilter</span><span class="token punctuation">(</span> <span class="token function">GetExceptionCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
   ……
<span class="token punctuation">}</span>

LONG <span class="token function">MyFilter</span> <span class="token punctuation">(</span> DWORD dwExceptionCode <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> dwExceptionCode <span class="token operator">==</span> EXCEPTION_ACCESS_VIOLATION <span class="token punctuation">)</span>
            <span class="token keyword">return</span> EXCEPTION_EXECUTE_HANDLER <span class="token punctuation">;</span>
    <span class="token keyword">else</span>
            <span class="token keyword">return</span> EXCEPTION_CONTINUE_SEARCH <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>显然方式2更好，对传入参数进行检查，如果异常类型是越权访问，则进行处理，否则则进行进一步搜索。</p> <p>下面介绍trycatch的全局展开流程。</p> <p><img src="/img/2018-04/Snipaste_2018-03-29_21-46-57.png" alt="全局展开流程"></p> <p>同时上代码：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;windows.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
using namespace std<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nStep <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">Function_B</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> x<span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
    \__try <span class="token punctuation">{</span>
        x <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">/</span> y <span class="token punctuation">;</span> <span class="token comment">// 引发异常</span>
    <span class="token punctuation">}</span>
    \__finally
    <span class="token punctuation">{</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Step &quot;</span> <span class="token operator">&lt;&lt;</span> nStep<span class="token operator">++</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; : 执行Function_B的finally块的内容&quot;</span> <span class="token operator">&lt;&lt;</span> endl <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Function_A</span> <span class="token punctuation">(</span> <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    \__try <span class="token punctuation">{</span>
        <span class="token function">Function_B</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    \__finally
    <span class="token punctuation">{</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Step &quot;</span> <span class="token operator">&lt;&lt;</span> nStep<span class="token operator">++</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; : 执行Function_A的finally块的内容&quot;</span> <span class="token operator">&lt;&lt;</span> endl <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">long</span> <span class="token function">MyExcepteFilter</span> <span class="token punctuation">(</span> <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Step &quot;</span> <span class="token operator">&lt;&lt;</span> nStep<span class="token operator">++</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; : 执行main的异常过滤器&quot;</span> <span class="token operator">&lt;&lt;</span> endl <span class="token punctuation">;</span>
    <span class="token keyword">return</span> EXCEPTION_EXECUTE_HANDLER <span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    \__try <span class="token punctuation">{</span>
        <span class="token function">Function_A</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">__except</span> <span class="token punctuation">(</span> <span class="token function">MyExcepteFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Step &quot;</span> <span class="token operator">&lt;&lt;</span> nStep<span class="token operator">++</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; : 执行main的except块的内容&quot;</span> <span class="token operator">&lt;&lt;</span> endl <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>程序的流程如下图所示。</p> <p><img src="/img/2018-04/Snipaste_2018-03-29_21-57-29.png" alt="全局展开流程分析"></p> <p>总体来说，当遇到嵌套的try-except时，首先递归向上查找过滤器的值，只有值是<code>EXCEPTION_EXECUTE_HANDLER</code>的时候，执行该except的功能（或自定义函数），然后回到递归的最底层，进行全局展开，递归向上进行finally块的输出。
当未进行异常处理时，产生异常，windows将弹出异常对话框。这个功能是在UnhandledExceptionFilter中实现的，在启动进程、线程时，系统会安装一个最顶层的异常处理try-except结构。</p> <p>上面就是VC封装后的SEH处理过程，下面讲下windows下的各种异常处理手段，从底层看VC是怎么封装SEH的。</p> <h3 id="veh、seh、vch、uef的系统实现"><a href="#veh、seh、vch、uef的系统实现" class="header-anchor">#</a> VEH、SEH、VCH、UEF的系统实现</h3> <p>SEH异常回调函数定义：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>EXCEPTION_DISPOSITION __cdecl <span class="token function">_except_handler</span> <span class="token punctuation">(</span>  
    <span class="token keyword">struct</span> \_EXCEPTION_RECORD <span class="token operator">*</span>\_ExceptionRecord<span class="token punctuation">,</span>  <span class="token comment">//异常记录结构指针</span>
    <span class="token keyword">void</span> <span class="token operator">*</span> \_EstablisherFrame<span class="token punctuation">,</span>  　　　　　　　　　　 <span class="token comment">//指向EXCEPTION_REGISTRATION结构,即SEH链</span>
    <span class="token keyword">struct</span> \_CONTEXT <span class="token operator">*</span>\_ContextRecord<span class="token punctuation">,</span>　　　　　　<span class="token comment">//Context结构指针 (线程上下文)</span>
    <span class="token keyword">void</span> <span class="token operator">*</span> \_DispatcherContext  　　　　　　　　　<span class="token comment">//无意义 (调度器上下文?)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>先看返回值。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token class-name">_EXCEPTION_DISPOSITION</span> <span class="token punctuation">{</span>  
    ExceptionContinueExecution<span class="token punctuation">,</span>         <span class="token comment">//0   重新执行异常指令</span>
    ExceptionContinueSearch<span class="token punctuation">,</span>            <span class="token comment">//1   搜索下一个SEH</span>
    ExceptionNestedException<span class="token punctuation">,</span>           <span class="token comment">//2  </span>
    ExceptionCollidedUnwind             <span class="token comment">//3  </span>
<span class="token punctuation">}</span> EXCEPTION_DISPOSITION<span class="token punctuation">;</span>  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>回调函数有4个指针，第一个是异常记录指针，在WINNT.H中定义，结构如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_EXCEPTION_RECORD</span> <span class="token punctuation">{</span>
    DWORD    ExceptionCode<span class="token punctuation">;</span>   <span class="token comment">//异常代码，说明是什么异常，比如单步、除零、断点等等</span>
    DWORD ExceptionFlags<span class="token punctuation">;</span>      <span class="token comment">//异常标志</span>
    <span class="token keyword">struct</span> \_EXCEPTION\_RECORD  \<span class="token operator">*</span>ExceptionRecord<span class="token punctuation">;</span>   <span class="token comment">//指向下一个异常记录（EXCEPTION\_RECORD）的指针</span>
    PVOID ExceptionAddress<span class="token punctuation">;</span>   <span class="token comment">//发生异常的地址</span>
    DWORD NumberParameters<span class="token punctuation">;</span>  <span class="token comment">//异常信息的个数（即数组ExceptionInformation的个数）</span>
    ULONG_PTR ExceptionInformation<span class="token punctuation">[</span>EXCEPTION_MAXIMUM_PARAMETERS<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">//异常信息数组</span>
<span class="token punctuation">}</span> EXCEPTION_RECORD<span class="token punctuation">,</span> <span class="token operator">*</span>PEXCEPTION_RECORD<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这个结构中的 ExcepitonCode成员是赋予异常的代码。通过在WINNT.H中搜索以“STATUS_”开头的＃define定义，你可以得到一个异常代码列表。例如<code>STATUS_ACCESS_VIOLATION</code>的代码是0xC0000005。一个更全面的异常代码列表可以在 Windows NT DDK的NTSTATUS.H中找到。此结构的第四个成员是异常发生的地址。其它成员暂时可以忽略。</p> <p>第三个参数是指向上下文的指针，在WINNT.H中定义，它代表某个特定线程的寄存器值。结构如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_CONTEXT</span> <span class="token punctuation">{</span>
    DWORD ContextFlags<span class="token punctuation">;</span>
    DWORD   Dr0<span class="token punctuation">,</span> Dr1<span class="token punctuation">,</span> Dr2<span class="token punctuation">,</span> Dr3<span class="token punctuation">,</span> Dr6<span class="token punctuation">,</span> Dr7<span class="token punctuation">;</span>
    FLOATING_SAVE_AREA FloatSave<span class="token punctuation">;</span>
    DWORD   SegGs<span class="token punctuation">,</span> SegFs<span class="token punctuation">,</span> SegEs<span class="token punctuation">,</span> SegDs<span class="token punctuation">;</span>
    DWORD   Edi<span class="token punctuation">,</span> Esi<span class="token punctuation">,</span> Edx<span class="token punctuation">,</span> Ebx<span class="token punctuation">,</span> Ecx<span class="token punctuation">,</span> Eax<span class="token punctuation">,</span> Ebp<span class="token punctuation">,</span> Eip<span class="token punctuation">;</span>
    DWORD   SegCs<span class="token punctuation">;</span>              <span class="token comment">// MUST BE SANITIZED</span>
    DWORD   EFlags<span class="token punctuation">;</span>             <span class="token comment">// MUST BE SANITIZED</span>
    DWORD   Esp<span class="token punctuation">;</span>
    DWORD   SegSs<span class="token punctuation">;</span>
    BYTE    ExtendedRegisters<span class="token punctuation">[</span>MAXIMUM_SUPPORTED_EXTENSION<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> CONTEXT<span class="token punctuation">,</span> <span class="token operator">*</span>PCONTEXT<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>这里的关键是_exept_handler回调函数接收到操作系统传递过来的许多有价值的信息，例如异常的类型和发生的地址。使用这些信息，异常回调函数就能决定下一步做什么。</p> <h4 id="exception-registration"><a href="#exception-registration" class="header-anchor">#</a> EXCEPTION_REGISTRATION</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_EXCEPTION_REGISTRATION</span> <span class="token punctuation">{</span>
    DWORD  prev<span class="token punctuation">;</span>        <span class="token comment">//* EXCEPTION_REGISTRATION</span>
    DWORD  handler<span class="token punctuation">;</span>     <span class="token comment">// \*\_except_handler</span>
<span class="token punctuation">}</span> EXCEPTION_REGISTRATION<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这个结构就是fs寄存器所指向的位置，即在WINNT.H的NT_TIB结构的定义中被称为_EXCEPITON_REGISTARTION_RECORD。这里的第一个参数是前一个EXCEPTION_REGISTRATION的指针，第二个参数是指向_except_handler回调函数的指针。</p> <p>当异常发生时，系统查找出错线程的TIB，获取指向EXCEPTION_REGISTRATION结构的指针。在这个结构中有一个指向_except_handler回调函数的指针。</p> <p><img src="/img/2018-04/Snipaste_2018-03-30_13-23-42.png" alt="异常处理过程"></p> <p>简单模拟上述过程：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;windows.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
using namespace std<span class="token punctuation">;</span>

DWORD scratch<span class="token punctuation">;</span>  
EXCEPTION_DISPOSITION  __cdecl  
<span class="token function">_except_handler</span><span class="token punctuation">(</span> <span class="token keyword">struct</span> \_EXCEPTION_RECORD <span class="token operator">*</span>ExceptionRecord<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span> EstablisherFrame<span class="token punctuation">,</span> <span class="token keyword">struct</span> \_CONTEXT <span class="token operator">*</span>ContextRecord<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span> DispatcherContext <span class="token punctuation">)</span>  
<span class="token punctuation">{</span>  
    <span class="token function">printf</span><span class="token punctuation">(</span> <span class="token string">&quot;Hello from an exception handler\nscratch:%#x\n&quot;</span><span class="token punctuation">,</span>scratch <span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// 改变CONTEXT结构中EAX的值，以便它指向可以成功进写操作的位置  </span>
    ContextRecord<span class="token operator">-&gt;</span>Eax <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span><span class="token operator">&amp;</span>scratch<span class="token punctuation">;</span>  
    <span class="token comment">// 告诉操作系统重新执行出错的指令  </span>
	<span class="token keyword">return</span> ExceptionContinueExecution<span class="token punctuation">;</span>
    <span class="token comment">// 若返回ExceptionContinueSearch则将继续搜索下一个SEH</span>
<span class="token punctuation">}</span>  

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
<span class="token punctuation">{</span>  
    DWORD handler <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>\_except_handler<span class="token punctuation">;</span>  
    \__asm  
    <span class="token punctuation">{</span>   
        <span class="token comment">// 创建EXCEPTION_REGISTRATION结构：  </span>
        push handler		<span class="token comment">// handler函数的地址  </span>
        push FS<span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>			<span class="token comment">// 前一个handler函数的地址  </span>
        mov FS<span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ESP		<span class="token comment">// 安装新的EXECEPTION_REGISTRATION结构  </span>
    <span class="token punctuation">}</span>  
    \__asm  
    <span class="token punctuation">{</span>  
        mov eax<span class="token punctuation">,</span><span class="token number">0</span>			<span class="token comment">// 将EAX清零  </span>
        mov <span class="token punctuation">[</span>eax<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span>		<span class="token comment">// 写EAX指向的内存从而故意引发一个错误  </span>
    <span class="token punctuation">}</span>  
    <span class="token function">printf</span><span class="token punctuation">(</span> <span class="token string">&quot;After writing!\n&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  
    \__asm  
    <span class="token punctuation">{</span>   
        <span class="token comment">// 移去我们的EXECEPTION_REGISTRATION结构  </span>
        mov eax<span class="token punctuation">,</span><span class="token punctuation">[</span>ESP<span class="token punctuation">]</span>		<span class="token comment">// 获取前一个结构  </span>
        mov FS<span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> EAX		<span class="token comment">// 安装前一个结构  </span>
        add esp<span class="token punctuation">,</span> <span class="token number">8</span>			<span class="token comment">// 将我们的EXECEPTION_REGISTRATION弹出堆栈  </span>
    <span class="token punctuation">}</span>  
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>这只是一种最简单的方法，下面将说明os实现的SEH链表。</p> <p><img src="/img/2018-04/Snipaste_2018-03-30_22-49-27.png" alt="查找EXCEPTION_REGISTRATION结构"></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;windows.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
EXCEPTION_DISPOSITION
__cdecl <span class="token function">_except_handler</span><span class="token punctuation">(</span>
              <span class="token keyword">struct</span> \_EXCEPTION_RECORD <span class="token operator">*</span>ExceptionRecord<span class="token punctuation">,</span>
              <span class="token keyword">void</span> <span class="token operator">*</span> EstablisherFrame<span class="token punctuation">,</span>
              <span class="token keyword">struct</span> \_CONTEXT <span class="token operator">*</span>ContextRecord<span class="token punctuation">,</span>
               <span class="token keyword">void</span> <span class="token operator">*</span> DispatcherContext <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span> <span class="token string">&quot;Home Grown handler: Exception Code: %08X Exception Flags %X&quot;</span><span class="token punctuation">,</span>
    ExceptionRecord<span class="token operator">-&gt;</span>ExceptionCode<span class="token punctuation">,</span> ExceptionRecord<span class="token operator">-&gt;</span>ExceptionFlags <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> ExceptionRecord<span class="token operator">-&gt;</span>ExceptionFlags <span class="token operator">&amp;</span> <span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token function">printf</span><span class="token punctuation">(</span> <span class="token string">&quot; EH_NONCONTINUABLE&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> ExceptionRecord<span class="token operator">-&gt;</span>ExceptionFlags <span class="token operator">&amp;</span> <span class="token number">2</span> <span class="token punctuation">)</span>
    <span class="token function">printf</span><span class="token punctuation">(</span> <span class="token string">&quot; EH_UNWINDING&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> ExceptionRecord<span class="token operator">-&gt;</span>ExceptionFlags <span class="token operator">&amp;</span> <span class="token number">4</span> <span class="token punctuation">)</span>
    <span class="token function">printf</span><span class="token punctuation">(</span> <span class="token string">&quot; EH_EXIT_UNWIND&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> ExceptionRecord<span class="token operator">-&gt;</span>ExceptionFlags <span class="token operator">&amp;</span> <span class="token number">8</span> <span class="token punctuation">)</span>
    <span class="token function">printf</span><span class="token punctuation">(</span> <span class="token string">&quot; EH_STACK_INVALID&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> ExceptionRecord<span class="token operator">-&gt;</span>ExceptionFlags <span class="token operator">&amp;</span> <span class="token number">0x10</span> <span class="token punctuation">)</span>
    <span class="token function">printf</span><span class="token punctuation">(</span> <span class="token string">&quot; EH_NESTED_CALL&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span> <span class="token string">&quot;\n&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 让其它函数处理</span>
    <span class="token keyword">return</span> ExceptionContinueSearch<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">HomeGrownFrame</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    DWORD handler <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>\_except_handler<span class="token punctuation">;</span>
    \__asm
    <span class="token punctuation">{</span>
       <span class="token comment">// 创建EXCEPTION_REGISTRATION结构：</span>
       push handler       <span class="token comment">// handler函数的地址</span>
       push FS<span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>        <span class="token comment">// 前一个handler函数的地址</span>
       mov FS<span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ESP     <span class="token comment">// 安装新的EXECEPTION_REGISTRATION结构</span>
    <span class="token punctuation">}</span>
    \<span class="token operator">*</span><span class="token punctuation">(</span>PDWORD<span class="token punctuation">)</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 写入地址0，从而引发一个错误</span>
    <span class="token comment">//这句话将不会被执行，因为回调函数返回继续搜索</span>
    <span class="token function">printf</span><span class="token punctuation">(</span> <span class="token string">&quot;I should never get here!\n&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    \__asm
    <span class="token punctuation">{</span>
       <span class="token comment">// 移去我们的EXECEPTION_REGISTRATION结构</span>
       mov eax<span class="token punctuation">,</span><span class="token punctuation">[</span>ESP<span class="token punctuation">]</span>            <span class="token comment">// 获取前一个结构</span>
       mov FS<span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> EAX          <span class="token comment">// 安装前一个结构</span>
       add esp<span class="token punctuation">,</span> <span class="token number">8</span>               <span class="token comment">// EXECEPTION_REGISTRATION结构弹出堆栈</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    \__try
    <span class="token punctuation">{</span>
        <span class="token function">HomeGrownFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">__except</span><span class="token punctuation">(</span> EXCEPTION_EXECUTE_HANDLER <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span> <span class="token string">&quot;Caught the exception in main()\n&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><p>因为_except_handler函数并没有打算修复出错的代码，因此它返回ExceptionContinueSearch。这导致操作系统继续在EXCEPTION_REGISTRATION结构链表中搜索下一个 EXCEPTION_REGISTRATION结构。接下来安装的异常回调函数是针对main函数中的__try/__except块的。__except块简单地打印出“Caught the exception in main()”。运行这个程序，会发现回调函数调用了2次，第二次是全局展开的原因。</p> <p>UEF、VEH、VCH异常处理函数定义（UEF和VEH、VCH的函数类型名不一样，但是结构是一样的）：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>LONG NTAPI <span class="token function">ExceptionHandler</span><span class="token punctuation">(</span><span class="token keyword">struct</span> \_EXCEPTION_POINTERS <span class="token operator">*</span>ExceptionInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>关于UEF、VEH、VCH函数的参数。参数只有一个，是指向结构_EXCEPTION_POINTERS的指针。具体结构如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_EXCEPTION_POINTERS</span> <span class="token punctuation">{</span>
    PEXCEPTION_RECORD ExceptionRecord<span class="token punctuation">;</span>  <span class="token comment">//异常记录（EXCEPTION_RECORD）的指针</span>
    PCONTEXT ContextRecord<span class="token punctuation">;</span>             <span class="token comment">//线程上下文的指针</span>
<span class="token punctuation">}</span> EXCEPTION_POINTERS<span class="token punctuation">,</span> <span class="token operator">*</span>PEXCEPTION_POINTERS<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这部分的详细内容就不写了，扯远了。参见参考资料。</p> <p>关于VC为使用结构化异常处理的函数生成的标准异常堆栈帧如下：scopetable域指向一个scopetable_entry结构数组，而trylevel域实际上是这个数组的索引</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>    EBP-00 _ebp
    EBP-04 trylevel
    EBP-08 scopetable数组指针
    EBP-0C handler函数地址
    EBP-10 指向前一个EXCEPTION_REGISTRATION结构
    EBP-14 GetExceptionInformation（EXCEPTION_POINTERS）
    EBP-18 栈帧中的标准ESP
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>SCOPETABLE结构中的第二个成员和第三个成员分别是过滤器表达式代码的地址和相应的__except块的地址。 prviousTryLevel用于嵌套的__try块。这里的关键是函数中的每个__try块都有一个相应的SCOPETABLE结构。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_SCOPETABLE</span>
<span class="token punctuation">{</span>
   DWORD previousTryLevel<span class="token punctuation">;</span>
   DWORD lpfnFilter<span class="token punctuation">;</span>
   DWORD lpfnHandler<span class="token punctuation">;</span>
<span class="token punctuation">}</span> SCOPETABLE<span class="token punctuation">,</span> <span class="token operator">*</span>PSCOPETABLE<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="异常处理机制执行顺序"><a href="#异常处理机制执行顺序" class="header-anchor">#</a> 异常处理机制执行顺序</h3> <p>SEH（结构化异常处理，基于线程栈的异常处理）
VEH（向量化异常处理，最顶端的异常处理）
VCH（同上，最低端 的异常处理 ）
UEF（TopLevelEH，顶级异常处理）</p> <p>异常处理器处理顺序流程：</p> <ol><li>交给调试器(进程必须被调试)</li> <li>执行VEH</li> <li>执行SEH</li> <li>TopLevelEH(进程被调试时不会被执行)</li> <li>执行VCH</li> <li>交给调试器(上面的异常处理都处理不了，就再次交给调试器)</li> <li>调用异常端口通知csrss.exe</li></ol> <p>关于SEH和windows下的异常处理就记这么多，已经够多的了，自己也感觉很多东西有点绕。有部分东西没记，更加深入和全面的知识点可以参照以下的链接。</p> <p><a href="https://blog.csdn.net/chenlycly/article/details/52575260" target="_blank" rel="noopener noreferrer">参考链接1<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="https://bbs.pediy.com/thread-223939.htm" target="_blank" rel="noopener noreferrer">参考链接2<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="https://bbs.pediy.com/thread-173853.htm" target="_blank" rel="noopener noreferrer">参考链接3<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="https://blog.csdn.net/mycsersoft/article/details/33307655" target="_blank" rel="noopener noreferrer">参考链接4<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="https://bbs.pediy.com/thread-32222.htm" target="_blank" rel="noopener noreferrer">参考链接5<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">2020年5月14日 02:37</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/ctf/reverse/learning-hacker-disassembling-2.html" class="prev">
        黑客反汇编揭秘笔记-2
      </a></span> <span class="next"><a href="/ctf/reverse/learning-hacker-disassembling-4.html">
        黑客反汇编揭秘笔记-4
      </a>
      →
    </span></p></div>  <!----> <script type="text/javascript">
        var _paq = window._paq || [];
        /* tracker methods like &quot;setCustomDimension&quot; should be called before &quot;trackPageView&quot; */
        _paq.push([&quot;setDocumentTitle&quot;, document.domain + &quot;/&quot; + document.title]);
        _paq.push(['trackPageView']);
        _paq.push(['enableLinkTracking']);
        (function() {
          var u=&quot;https://zjgcjy.top:1234/&quot;;
          _paq.push(['setTrackerUrl', u+'matomo.php']);
          _paq.push(['setSiteId', '2']);
          var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
          g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
        })();
      </script></main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.68a3742c.js" defer></script><script src="/assets/js/8.fcc732cc.js" defer></script><script src="/assets/js/3.c25269db.js" defer></script><script src="/assets/js/38.9cad802b.js" defer></script><script src="/assets/js/4.4107640d.js" defer></script>
  </body>
</html>
