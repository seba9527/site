(window.webpackJsonp=window.webpackJsonp||[]).push([[121],{554:function(e,t,n){"use strict";n.r(t);var r=n(14),s=Object(r.a)({},(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("blockquote",[n("p",[e._v("详细记录对基于Xen虚拟化的Windows系统双机内核调试的配置步骤")])]),e._v(" "),n("hr"),e._v(" "),n("h2",{attrs:{id:"基本原理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#基本原理"}},[e._v("#")]),e._v(" 基本原理")]),e._v(" "),n("p",[e._v("大致的流程是：虚拟串口——TCP——虚拟串口")]),e._v(" "),n("p",[e._v("使用windbg的串口调试功能。由于调试主机没有串口，采用创建虚拟串口的方式，使用sockpipe工具，创建管道，如此windbg能顺利接上这个管道，并将管道映射到本机的一个端口上，供目标主机链接。然后在目标主机上设置相应的参数，在虚拟机上也创建一个虚拟串口，同时通过TCP链接到调试主机的端口上，创建整条调试通路。最后只要设置虚拟机的调试参数就可以了。")]),e._v(" "),n("p",[e._v("下面讲详细对依赖环境及工具进行说明。")]),e._v(" "),n("h2",{attrs:{id:"调试主机（os：windows-10）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#调试主机（os：windows-10）"}},[e._v("#")]),e._v(" 调试主机（OS：Windows 10）")]),e._v(" "),n("ul",[n("li",[e._v("关闭防火墙，允许ICMP和TCP报文通过，开放端口")]),e._v(" "),n("li",[e._v("关闭可能造成网络不稳定影响的安全软件")]),e._v(" "),n("li",[e._v("安装windbg，最好安装WDK/SDK，并配置符号路径")]),e._v(" "),n("li",[e._v("安装Xen开发人员的sockpipe工具")])]),e._v(" "),n("p",[e._v("使用sockpipe创建一个管道，指定管道名称和映射的端口号。")]),e._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[e._v("sockpipe.exe "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("pipename"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("port"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])]),n("p",[n("img",{attrs:{src:"%22_img/Snipaste_2019-07-24_16-47-08.png%22",alt:"Snipaste_2019-07-24_16-47-08"}})]),e._v(" "),n("p",[e._v("这样调试线路的一端就可以了，打开windbg，设置串口调试并指定管道名称和波特率（波特率必须和下文中的波特率匹配）并等待虚拟机连上即可。")]),e._v(" "),n("p",[n("img",{attrs:{src:"/img/2019-07/Snipaste_2019-07-24_16-53-11.png",alt:"Snipaste_2019-07-24_16-53-11"}})]),e._v(" "),n("h2",{attrs:{id:"目标主机（os：基于xen的ubuntu18）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#目标主机（os：基于xen的ubuntu18）"}},[e._v("#")]),e._v(" 目标主机（OS：基于Xen的Ubuntu18）")]),e._v(" "),n("ul",[n("li",[e._v("关闭防火墙，配置iptables，允许ICMP和TCP报文通过，开放端口")]),e._v(" "),n("li",[e._v("关闭selinux，防止干扰")])]),e._v(" "),n("p",[e._v("设置虚拟机的配置文件，最重要的是serial的值。")]),e._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("serial")]),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[e._v("'tcp:<ip>:<port>, nodelay'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])]),n("p",[e._v("其中的ip是调试主机的ip，端口号对应了sockpipe创建的端口号，同时指定参数是nodelay。")]),e._v(" "),n("p",[n("img",{attrs:{src:"/img/2019-07/Snipaste_2019-07-24_16-57-50.png",alt:"Snipaste_2019-07-24_16-57-50"}})]),e._v(" "),n("p",[e._v("同时配合netstat和top等命令查看是否连接上对应的ip地址，否则虚拟机将无法启动。")]),e._v(" "),n("h2",{attrs:{id:"被调试虚拟机（os：windows-7-x86-sp0）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#被调试虚拟机（os：windows-7-x86-sp0）"}},[e._v("#")]),e._v(" 被调试虚拟机（OS：Windows 7 x86 sp0）")]),e._v(" "),n("ul",[n("li",[e._v("关闭防火墙，允许ICMP和TCP报文通过，开放端口")]),e._v(" "),n("li",[e._v("关闭可能造成网络不稳定影响的安全软件")])]),e._v(" "),n("p",[e._v("如果上文配置正确，正常启动虚拟机，将在设备管理器中看见新添加的一个串口。")]),e._v(" "),n("p",[n("img",{attrs:{src:"/img/2019-07/Snipaste_2019-07-24_17-08-40.png",alt:"Snipaste_2019-07-24_17-08-40"}})]),e._v(" "),n("p",[e._v("这时再通过msconfig配置虚拟机，创建一个新的启动项，同时设置成调试模式，指定串口对应的端口号和波特率。")]),e._v(" "),n("p",[n("img",{attrs:{src:"/img/2019-07/Snipaste_2019-07-24_17-00-29.png",alt:"Snipaste_2019-07-24_17-00-29"}})]),e._v(" "),n("p",[e._v("之后再通过bcdedit查看创建是否成功。特别是调试类型、端口和可调试选项，如下图所示。")]),e._v(" "),n("p",[n("img",{attrs:{src:"/img/2019-07/Snipaste_2019-07-24_17-03-20.png",alt:"Snipaste_2019-07-24_17-03-20"}})]),e._v(" "),n("p",[e._v("然后重新启动虚拟机，并选择调试模式进入。此时windbg将在Windows启动界面回显，sockpipe也会有回显。")]),e._v(" "),n("p",[n("img",{attrs:{src:"/img/2019-07/Snipaste_2019-07-24_17-11-05.png",alt:"Snipaste_2019-07-24_17-11-05"}})]),e._v(" "),n("h2",{attrs:{id:"参考资料"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[e._v("#")]),e._v(" 参考资料")]),e._v(" "),n("p",[n("a",{attrs:{href:"https://github.com/OpenXT/openxt/wiki/Windows-HVM-Debugging",target:"_blank",rel:"noopener noreferrer"}},[e._v("Windows-HVM-Debugging"),n("OutboundLink")],1),e._v(" "),n("a",{attrs:{href:"http://vikashkumarroy.blogspot.com/2012/08/how-to-capture-memory-dump-of-windows.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("how-to-capture-memory-dump-of-windows"),n("OutboundLink")],1),e._v(" "),n("a",{attrs:{href:"https://xenserver.org/partners/developing-products-for-xenserver/18-sdk-development/135-xs-dev-windbg.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("DEBUGGING WINDOWS GUESTS ON XENSERVER"),n("OutboundLink")],1),e._v(" "),n("a",{attrs:{href:"https://resources.infosecinstitute.com/kernel-debugging-qemu-windbg/",target:"_blank",rel:"noopener noreferrer"}},[e._v("kernel-debugging-qemu-windbg"),n("OutboundLink")],1),e._v(" "),n("a",{attrs:{href:"http://xenbits.xen.org/docs/4.2-testing/man/xl.cfg.5.html#SYNOPSIS",target:"_blank",rel:"noopener noreferrer"}},[e._v("xen配置手册"),n("OutboundLink")],1),e._v(" "),n("a",{attrs:{href:"https://gist.github.com/nstarke/3c42342942138ee965a8c40054c1dbd7",target:"_blank",rel:"noopener noreferrer"}},[e._v("XEN下两台VM调试"),n("OutboundLink")],1),e._v(" "),n("a",{attrs:{href:"https://docs.microsoft.com/zh-cn/windows-hardware/drivers/debugger/setting-up-kernel-mode-debugging-in-windbg--cdb--or-ntsd",target:"_blank",rel:"noopener noreferrer"}},[e._v("微软如何设置内核模式调试"),n("OutboundLink")],1),e._v(" "),n("a",{attrs:{href:"https://www.cnblogs.com/BiffoLee/archive/2012/02/01/2334089.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("windows内核调试配置"),n("OutboundLink")],1),e._v(" "),n("a",{attrs:{href:"http://old-list-archives.xenproject.org/archives/html/xen-devel/2009-08/msg00268.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("How to use windbg to debug XEN windows XP domainU under Suse"),n("OutboundLink")],1),e._v(" "),n("a",{attrs:{href:"https://stackoverflow.com/questions/32964402/kernel-debugging-a-windows-guest-system-from-a-linux-system-setup-not-working",target:"_blank",rel:"noopener noreferrer"}},[e._v("kernel-debugging-a-windows-guest-system-from-a-linux-system-setup-not-working"),n("OutboundLink")],1),e._v(" "),n("a",{attrs:{href:"https://stackoverflow.com/questions/12696825/debugging-windows-kernel-from-linux",target:"_blank",rel:"noopener noreferrer"}},[e._v("Debugging Windows Kernel from Linux"),n("OutboundLink")],1),e._v(" "),n("a",{attrs:{href:"https://reverseengineering.stackexchange.com/questions/2297/windows-kernel-debugging-on-mac-host-using-vmware-fusion",target:"_blank",rel:"noopener noreferrer"}},[e._v("windows-kernel-debugging-on-mac-host-using-vmware-fusion"),n("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=s.exports}}]);